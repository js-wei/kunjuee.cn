<include file="Common:header"/>
    <!--BEGIN FORM STYLE-->
    <link rel="stylesheet" type="text/css" href="__PLUG__/kindeditor/themes/default/default.css">
    <link rel="stylesheet" href="__PLUG__/kindeditor/plugins/code/prettify.css" />
    <script charset="utf-8" src="__PLUG__/kindeditor/kindeditor.js"></script>
    <script charset="utf-8" src="__PLUG__/kindeditor/lang/zh_CN.js"></script>
    <script charset="utf-8" src="__PLUG__/kindeditor/plugins/code/prettify.js"></script>
    <!--END FORM STYLE-->
    <!-- BEGIN CONTAINER -->
    <div class="page-container">
        <!-- BEGIN SIDEBAR -->
        <include file="Common:nav"/>
        <!-- END SIDEBAR -->
        <!-- BEGIN PAGE -->
        <div class="page-content fill-content">
            <!-- BEGIN PAGE CONTAINER-->
            <div class="container-fluid">
                <!-- BEGIN PAGE HEADER-->
                <div class="row-fluid">
                    <div class="span12">
                        <!-- BEGIN PAGE TITLE & BREADCRUMB-->
                        <h3 class="page-title">
                            Dashboard <small>statistics and more</small>
                        </h3>
                        <ul class="breadcrumb">
                            <li>
                                <i class="icon-home"></i>
                                <a href="{:U('Index/index')}">首页</a>
                                <i class="icon-angle-right"></i>
                            </li>
                            <li>
                                <php>
                                    $column = M('column')->find($_GET['id']);
                                </php>
                                <a href="__URL__/index?id={$Think.get.id}">{$column.title}</a>
                            </li>
                            <li class="pull-right no-text-shadow">
                                <div id="dashboard-report-range" class="dashboard-date-range tooltips no-tooltip-on-touch-device responsive"
                                     data-tablet="" data-desktop="tooltips" data-placement="top" data-original-title="Change dashboard date range">
                                    <i class="icon-calendar"></i>
                                    <span></span>
                                    <i class="icon-angle-down"></i>
                                </div>
                            </li>
                        </ul>
                        <!-- END PAGE TITLE & BREADCRUMB-->
                    </div>
                </div>
                <!-- END PAGE HEADER-->
                <!--BEGIN PAGER FORM-->
                <div class="row-fluid">
                    <div class="span12">
                        <div class="portlet box purple">
                            <div class="portlet-title">
                                <div class="caption"><i class="icon-reorder"></i>{$model.name|default='添加图片'}</div>
                                <div class="tools">
                                    <a href="javascript:;" class="collapse"></a>
                                    <a href="#portlet-config" data-toggle="modal" class="config"></a>
                                    <a href="javascript:;" class="reload" data-role="__METRONIC_IMG__/fancybox_loading.gif" data-form="form_sample_1" data-reset="1"></a>
                                    <a href="javascript:;" class="remove"></a>
                                </div>
                            </div>
                            <div class="portlet-body form">
                                <!-- BEGIN FORM-->
                                <form action="__URL__/InsertAtlas" method="post" id="form_sample_3" class="form-horizontal" novalidate="novalidate"  enctype="multipart/form-data">
                                    <div class="alert alert-error hide">
                                        <button class="close" data-dismiss="alert"></button>
                                                                               请填写完表单在提交
                                    </div>
                                    <div class="alert alert-success hide">
                                        <button class="close" data-dismiss="alert"></button>
                                                                               请填写完表单完成
                                    </div>
                                    <div class="control-group">
                                        <label class="control-label">添加图片<span class="required">*</span></label>
                                        <div class="controls">
                                        	<input type="button" id="J_selectImage" value="批量上传" />
                                            <div id="JimageView" style="padding-left:0px;margin-top:10px;">
							                    <notempty name="info">
							                        <volist name="info" id="vo">
														<span style="width:220px;display:inline-block;position:relative;height:410px;overflow:hidden;margin-left:2px;" class="iamgeDiv" data-role="{$vo.id}">
															<img src="{$vo.image}" data-role="{$vo.id}" style="margin:0 auto; width:125px;height:110px">
															<a href="javascript:void(0);" style="position:absolute;color:#777;right:15px;" onclick="removeImage(this)"><i class="icon-remove"></i></a>
															<input type="hidden" name="image[{$vo.id}][image]" value="{$vo.image}">
															<div style="margin-top:10px;width:180px;">
																<input type="text" name="image[{$vo.id}][title]" value="{$vo.title}" placeholder="图片标题" />
															</div>
															<div style="margin-top:10px;width:180px;">
																<textarea name="image[{$vo.id}][description]" rows="4" placeholder="图片说明">{$vo.description}</textarea>
															</div>
															<div style="margin-top:10px;width:180px;">
																<input type="text" name="image[{$vo.id}][sort]" value="{$vo.sort|default='100'}" placeholder="排序"/>
															</div>
															<div style="margin-top:10px;width:180px;">
																<label class="radio-inline inline-width">
					                                                <input type="radio" name="image[{$vo.id}][status]"  value="0" <eq name="vo.status" value="0">checked<else /> checked="checked"</eq> >启用
					                                            </label>
					                                            <label class="radio-inline inline-width">
					                                                <input type="radio" name="image[{$vo.id}][status]"  value="1" <eq name="vo.status" value="1">checked</eq>>禁用
					                                            </label>
															</div>
														</span>
							                        </volist>
							                    </notempty>
							                </div>
                                            <input type="hidden" value="{$Think.get.aid}" name="cid">
                                            <input type="hidden" value="{$Think.get.p}" name="p">
                                            <input type="hidden" value="{$Think.get.cid}" name="id">
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn purple">提交</button>
                                        <button type="button" class="btn" onclick="window.history.go(-1);">返回</button>
                                    </div>
                                </form>
                                <!-- END FORM-->
                            </div>
                        </div>
                    </div>
                </div>
                <!--END PAGER FORM-->
            </div>
            <!-- END PAGE CONTAINER-->    
        </div>
        <!-- END PAGE -->
    </div>
    <!-- END CONTAINER -->
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script type="text/javascript" src="__METRONIC_JS__/jquery.validate.min.js"></script>
    <script type="text/javascript" src="__METRONIC_JS__/additional-methods.min.js"></script>
    <script type="text/javascript" src="__METRONIC_JS__/select2.min.js"></script>
    <script type="text/javascript" src="__METRONIC_JS__/chosen.jquery.min.js"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN PAGE LEVEL STYLES -->
    <script type="text/javascript" src="__METRONIC_JS__/form-validation.js"></script>
    <script type="text/javascript" src="__METRONIC_JS__/form-checked.js"></script>
    <script type="text/javascript">
        $(function(){
        	
		    KindEditor.ready(function(K) {
				var editor = K.editor({
					allowFileManager : true,
					uploadJson:"{:U('Uploadify/KindEditorUploadImage')}",
		            width : "680px",
		            height : "350px",
				});
				K('#J_selectImage').click(function() {
					editor.loadPlugin('multiimage', function() {
						editor.plugin.multiImageDialog({
							clickFn : function(urlList) {
								var div = K('#JimageView');
								var last = K('span.iamgeDiv').length;
								//div.html('');
								K.each(urlList, function(i, data) {
									i = parseInt(last) + ++i;
									$html = '<span style="width:220px;display:inline-block;position:relative;height:410px;overflow:hidden;margin-left:2px;" class="iamgeDiv" data-role="'+i+'">';
									$html += '	<img src="' + data.url + '" data-role="'+i+'" style="margin:0 auto;width:125px;height:110px;">';
									$html += '	<a href="javascript:void(0);" style="position:absolute;color:#777;right:15px;" onclick="removeImage(this)"><i class="icon-remove"></i></a>';
									$html += '	<!--<a href="javascript:void(0);" style="position:absolute;color:#777;right:0px;" onclick="addDescription(this)"><i class="icon-plus"></i></a>-->';
									$html += '	<input type="hidden" name="image['+i+'][image]" value="'+ data.url + '">';
									$html += '	<div style="margin-top:10px;width:180px;">';
									$html += '		<input type="text" name="image['+i+'][title]" placeholder="图片标题"/>';
									$html += '	</div>';
									$html += '	<div style="margin-top:10px;width:180px;">';
									$html += '		<textarea name="image['+i+'][description]" rows="4" placeholder="图片说明" style="margin-top:10px;"></textarea>';
									$html += '	</div>';
									$html += '	<div style="margin-top:10px;width:180px;">';
									$html += '		<input type="text" name="image['+i+'][sort]" value="100" placeholder="排序"/>';
									$html += '	</div>';
									$html += '	<div style="margin-top:10px;width:180px;">';
									$html += '		<label class="radio-inline inline-width">';
                                    $html += '            <input type="radio" name="image['+i+'][status]" value="0"  checked="checked">启用';
                                    $html += '        </label>';
                                    $html += '        <label class="radio-inline inline-width">';
                                    $html += '            <input type="radio" name="image['+i+'][status]" value="1">禁用';
                                    $html += '        </label>';
									$html += '	</div>';
									$html += '</span>';
									div.append($html);
								});
								editor.hideDialog();
							}
						});
					});
				});
			});
	        $('form').submit(function(e){
                e.preventDefault();
                if($('form').valid()){
                	console.log($('form').serialize());
                    var index = layer.load(2,{
						shade: [0.4,'#fff'] //0.1透明度的白色背景
					});
	                $.post($('form').attr('action'),$('form').serialize(),function(data){
	                    layer.close(index);
						if(data.status==1){
	                        layer.alert(data.msg,{icon:6,end:function(){
	                            location.href = data.redirect;
	                        }});
	                    }else {
	                        layer.alert(data.msg,{icon:5});
	                    }
	                })
                }
            });
        });
        /**
         * 删除上传图片
         * @param {Object} obj
         */
        function removeImage(obj){
			$obj=$(obj);
			$parent = $obj.parent('span');
			$src = $parent.children('img').eq(0).attr('src');
			var index = layer.load(2,{
				shard:['#000','0.4']
			});
			$.post("{:U('Uploadify/delmg1')}",{src:$src},function(data){
				layer.close(index);
				if(data.status==1){
					$parent.remove();
				}else{
					art.dialog({time:1,content: data.msg});
				}
			});
		}
    </script>
    <!-- END PAGE LEVEL STYLES -->
<include file="Common:footer"/>